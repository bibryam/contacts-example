#!/bin/bash
set -eo pipefail


echo "========================================="
echo "======= Starting Custom S2I Build ======="

# Uncomment to run original assemble script
# /usr/local/s2i/assemble


# BUNDLE_NAME="${ARTIFACT_ID}-${ARTIFACT_VERSION}.tar.gz"

BUNDLE_NAME="demo-1.0-20160831.122115-31-app.zip"
BUNDLE_FULL_PATH="${NEXUS_URL}/content/${REPOSITORY_NAME}/${GROUP_ID}/${ARTIFACT_ID}/${ARTIFACT_VERSION}/$BUNDLE_NAME"
  
echo "Started CURL Download from $BUNDLE_FULL_PATH"

curl -H "Accept: application/zip" $BUNDLE_FULL_PATH -o /deployments/$BUNDLE_NAME
if [ 0 -eq $? ]; then
  echo "Download complete"
else
  echo "Failed to Download Release Bundle"
  exit 1
fi;
echo "Unpacking /deployments/$BUNDLE_NAME..."
pushd /deployments
  unzip $BUNDLE_NAME
  pushd $ARTIFACT_ID-$ARTIFACT_VERSION-app
      ls -la
      mv bin/ lib/ ../
  popd
  ls -la
  rm -rf $ARTIFACT_ID-$ARTIFACT_VERSION-app
  rm -f $BUNDLE_NAME
popd

echo "======= Custom S2I Build Complete ======="
echo "========================================="

